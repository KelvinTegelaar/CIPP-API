
function Get-CIPPAlertDefenderMalware {
    <#
    .FUNCTIONALITY
        Entrypoint
    #>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $false)]
        [Alias('input')]
        $InputValue,
        $TenantFilter
    )
    try {
        $TenantId = (Get-Tenants | Where-Object -Property defaultDomainName -EQ $TenantFilter).customerId
        $AlertData = New-GraphGetRequest -uri "https://graph.microsoft.com/beta/tenantRelationships/managedTenants/windowsDeviceMalwareStates?`$top=999&`$filter=tenantId eq '$($TenantId)'" | Where-Object { $_.malwareThreatState -eq 'Active' } | ForEach-Object {
            [PSCustomObject]@{
                DeviceName               = $_.managedDeviceName
                MalwareName              = $_.malwareDisplayName
                MalwareSeverity          = $_.malwareSeverity
                ThreatState              = $_.malwareThreatState
                AdditionalInformationUrl = $_.additionalInformationUrl
                InitialDetectionDateTime = $_.initialDetectionDateTime
                LastStateChangeDateTime  = $_.lastStateChangeDateTime
                DetectionCount           = $_.detectionCount
                Tenant                   = $TenantFilter
                TenantId                 = $_.tenantId
            }
        }
        Write-AlertTrace -cmdletName $MyInvocation.MyCommand -tenantFilter $TenantFilter -data $AlertData

    } catch {
        Write-LogMessage -API 'Alerts' -tenant $($TenantFilter) -message "Could not get malware data for $($TenantFilter): $(Get-NormalizedError -message $_.Exception.message)" -sev Error
    }
}
